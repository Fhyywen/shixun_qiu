<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çŸ¥è¯†åº“</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ</h1>
            <p>æé—®å…³äºARIMAã€Prophetã€LSTMç­‰æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çš„é—®é¢˜</p>
        </header>

        <main>
            <!-- é—®ç­”åŒºåŸŸ -->
            <form id="question-form">
                <div class="input-group">
                    <input type="text" id="question-input" placeholder="è¯·è¾“å…¥å…³äºæ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çš„é—®é¢˜..." autocomplete="off">
                    <button type="submit">æé—®</button>
                </div>
            </form>

            <div id="answer-container">
                <div id="answer"></div>
                <div id="references"></div>
            </div>

            <div id="loading" class="hidden">
                <p>æ­£åœ¨æ€è€ƒä¸­...</p>
            </div>

            <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
            <div class="file-manager">
                <!-- ç§»é™¤ï¼š
                <div class="upload-section">
                    <h3>ä¸Šä¼ æ–°æ–‡ä»¶</h3>
                    <form id="upload-form" enctype="multipart/form-data">
                        <input type="file" id="file-upload" accept=".md" />
                        <button type="submit">ä¸Šä¼ </button>
                    </form>
                </div>
                -->

                <!-- ä¿®æ”¹æ–‡ä»¶ç®¡ç†åŒºåŸŸçš„ç»“æ„ -->
                <div class="files-section">
                    <h3>çŸ¥è¯†åº“ç»“æ„</h3>
                    <div id="structure-path">
                        <span class="path-item" data-path="">æ ¹ç›®å½•</span>
                    </div>
                    <!-- ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ åŒºåŸŸçš„acceptå±æ€§ -->
                    <div id="folder-upload" class="upload-section hidden">
                        <h4>ä¸Šä¼ æ–‡ä»¶åˆ°å½“å‰ç›®å½•</h4>
                            <form id="folder-upload-form" enctype="multipart/form-data">
                                <input type="file" id="folder-file-upload" accept=".txt,.md,.rst,.csv,.xlsx,.xls,.docx,.pdf" />
                                <button type="submit">ä¸Šä¼ </button>
                            </form>

                            <!-- æ–°å»ºæ–‡ä»¶å¤¹åŠŸèƒ½ç§»åˆ°è¿™é‡Œ -->
                            <div class="new-folder-section">
                                <h4>æ–°å»ºæ–‡ä»¶å¤¹</h4>
                                <input type="text" id="new-folder-name" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
                                <button id="create-folder-btn">åˆ›å»º</button>
                            </div>
                    </div>

                    <div id="structure-list">
                        <!-- ç›®å½•ç»“æ„å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æ–‡ä»¶ç¼–è¾‘åŒºåŸŸ -->
                <div class="edit-section hidden" id="edit-section">
                    <h3>ç¼–è¾‘æ–‡ä»¶</h3>
                    <input type="hidden" id="edit-filename" />
                    <input type="hidden" id="edit-filepath" />
                    <textarea id="file-content" rows="10"></textarea>
                    <div class="edit-buttons">
                        <button id="save-edit">ä¿å­˜</button>
                        <button id="cancel-edit">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // é—®ç­”åŠŸèƒ½ä¿æŒä¸å˜
        document.getElementById('question-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const questionInput = document.getElementById('question-input');
            const question = questionInput.value.trim();

            if (!question) return;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('answer').innerHTML = '';
            document.getElementById('references').innerHTML = '';

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'question': question
                    })
                });

                const data = await response.json();

                if (data.error) {
                    document.getElementById('answer').innerHTML = `<p class="error">${data.error}</p>`;
                } else {
                    document.getElementById('answer').innerHTML = `<p>${data.answer.replace(/\n/g, '<br>')}</p>`;

                    if (data.results && data.results.length > 0) {
                        let referencesHtml = '<h3>å‚è€ƒæ¥æº:</h3><ul>';
                        data.results.forEach(result => {
                            referencesHtml += `<li>${result.metadata.title} (ç›¸ä¼¼åº¦: ${(1 - result.distance).toFixed(3)})</li>`;
                        });
                        referencesHtml += '</ul>';
                        document.getElementById('references').innerHTML = referencesHtml;
                    }
                }
            } catch (error) {
                document.getElementById('answer').innerHTML = `<p class="error">è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            } finally {
                document.getElementById('loading').classList.add('hidden');
                questionInput.value = '';
            }
        });

        // æ›¿æ¢åŸæœ‰çš„æ–‡ä»¶ç®¡ç†ç›¸å…³JSä»£ç 

// åœ¨DOMContentLoadedäº‹ä»¶ä¸­æ›¿æ¢åŸä¸Šä¼ è¡¨å•äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', () => {
    // åŠ è½½ç›®å½•ç»“æ„
    loadStructure();

    // æ–‡ä»¶å¤¹å†…ä¸Šä¼ æ–‡ä»¶è¡¨å•æäº¤
    document.getElementById('folder-upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('folder-file-upload');
        if (!fileInput.files.length) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        // æ·»åŠ å½“å‰æ–‡ä»¶å¤¹è·¯å¾„
        formData.append('folder_path', getCurrentPath());

        try {
            const response = await fetch('/upload-financial-file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.error) {
                alert(result.error);
            } else {
                alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                loadStructure(getCurrentPath());
                fileInput.value = '';
            }
        } catch (error) {
            alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
        }
    });

    // å–æ¶ˆç¼–è¾‘
    document.getElementById('cancel-edit').addEventListener('click', () => {
        document.getElementById('edit-section').classList.add('hidden');
        document.getElementById('edit-filename').value = '';
        document.getElementById('edit-filepath').value = '';
        document.getElementById('file-content').value = '';
    });

    // ä¿å­˜ç¼–è¾‘
    document.getElementById('save-edit').addEventListener('click', async () => {
        const filename = document.getElementById('edit-filename').value;
        const filepath = document.getElementById('edit-filepath').value;
        const content = document.getElementById('file-content').value;

        if (!filename || !content) return;

        // æ„å»ºå®Œæ•´è·¯å¾„
        const fullPath = filepath ? `${filepath}/${filename}` : filename;

        try {
            const response = await fetch('/save-financial-file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: fullPath,
                    content: content
                })
            });

            const result = await response.json();
            if (result.error) {
                alert(result.error);
            } else {
                alert('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                document.getElementById('edit-section').classList.add('hidden');
                loadStructure(getCurrentPath());
            }
        } catch (error) {
            alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    });
    // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('create-folder-btn').addEventListener('click', async () => {
        const folderName = document.getElementById('new-folder-name').value.trim();
        if (!folderName) {
            alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤¹åç§°æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦
        if (/[<>:"/\\|?*]/.test(folderName)) {
            alert('æ–‡ä»¶å¤¹åç§°ä¸èƒ½åŒ…å«ä»¥ä¸‹å­—ç¬¦: < > : " / \\ | ? *');
            return;
        }

        const currentPath = getCurrentPath();

        try {
            const response = await fetch('/create-folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    folder_name: folderName,
                    parent_path: currentPath
                })
            });

            const result = await response.json();
            if (result.error) {
                alert(result.error);
            } else {
                alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                document.getElementById('new-folder-name').value = '';
                loadStructure(currentPath); // åˆ·æ–°å½“å‰ç›®å½•
            }
        } catch (error) {
            alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
        }
    });
});

// ä¿®æ”¹è·å–å½“å‰è·¯å¾„çš„å‡½æ•°
function getCurrentPath() {
    // ä»è·¯å¾„å¯¼èˆªçš„æœ€åä¸€ä¸ªå…ƒç´ è·å–å®Œæ•´è·¯å¾„
    const pathItems = document.querySelectorAll('#structure-path .path-item');
    if (pathItems.length === 0) return '';

    // è·å–æœ€åä¸€ä¸ªè·¯å¾„é¡¹çš„data-pathå±æ€§ï¼ˆè¿™æ˜¯æœ€å‡†ç¡®çš„å½“å‰è·¯å¾„ï¼‰
    const lastItem = pathItems[pathItems.length - 1];
    return lastItem.getAttribute('data-path') || '';
}

async function loadStructure(path = '') {
    try {
        const response = await fetch('/list-financial-structure');
        const structure = await response.json();

        if (structure.error) {
            document.getElementById('structure-list').innerHTML = `<p class="error">${structure.error}</p>`;
            return;
        }

        // æ›´æ–°è·¯å¾„å¯¼èˆª
        updatePathNavigation(path);

        // æ˜¾ç¤ºæˆ–éšè—æ–‡ä»¶å¤¹å†…ä¸Šä¼ åŒºåŸŸ
        const uploadSection = document.getElementById('folder-upload');
        if (path || structure.length > 0) { // æ ¹ç›®å½•ä¹Ÿæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            uploadSection.classList.remove('hidden');
        } else {
            uploadSection.classList.add('hidden');
        }

        // æ‰¾åˆ°å½“å‰è·¯å¾„å¯¹åº”çš„ç»“æ„
        const currentStructure = findStructureByPath(structure, path);

        // æ¸²æŸ“ç»“æ„åˆ—è¡¨
        renderStructureList(currentStructure);
    } catch (error) {
        console.error('åŠ è½½ç›®å½•ç»“æ„å¤±è´¥:', error);
    }
}

// æ›´æ–°è·¯å¾„å¯¼èˆª--ä¿®å¤
function updatePathNavigation(currentPath) {
    const pathContainer = document.getElementById('structure-path');
    pathContainer.innerHTML = '';

    // æ·»åŠ æ ¹ç›®å½•
    const rootItem = document.createElement('span');
    rootItem.className = 'path-item';
    rootItem.setAttribute('data-path', '');
    rootItem.textContent = 'æ ¹ç›®å½•';
    rootItem.addEventListener('click', () => loadStructure(''));
    pathContainer.appendChild(rootItem);

    if (!currentPath) return;

    // åˆ†å‰²è·¯å¾„
    const pathParts = currentPath.split('/');
    let fullPath = '';

    pathParts.forEach((part, index) => {
        const separator = document.createElement('span');
        separator.textContent = ' / ';
        pathContainer.appendChild(separator);

        // è®¡ç®—å½“å‰éƒ¨åˆ†çš„å®Œæ•´è·¯å¾„
        fullPath = index === 0 ? part : `${fullPath}/${part}`;

        const pathItem = document.createElement('span');
        pathItem.className = 'path-item';
        pathItem.setAttribute('data-path', fullPath);
        pathItem.setAttribute('data-name', part);
        pathItem.textContent = part;

        // ä¿®å¤ï¼šä½¿ç”¨é—­åŒ…ä¿å­˜å½“å‰fullPathçš„å€¼
        (function(currentFullPath) {
            pathItem.addEventListener('click', () => {
                loadStructure(currentFullPath);
            });
        })(fullPath);

        pathContainer.appendChild(pathItem);
    });
}

// æ ¹æ®è·¯å¾„æŸ¥æ‰¾ç»“æ„
function findStructureByPath(structure, path) {
    if (!path) return structure;

    const pathParts = path.split('/');
    let currentStructure = structure;

    for (const part of pathParts) {
        const found = currentStructure.find(item => item.name === part && item.is_dir);
        if (!found) return [];
        currentStructure = found.children;
    }

    return currentStructure;
}

// æ¸²æŸ“ç»“æ„åˆ—è¡¨
function renderStructureList(structure) {
    const listContainer = document.getElementById('structure-list');
    listContainer.innerHTML = '';

    if (structure.length === 0) {
        listContainer.innerHTML = '<p>è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</p>';
        return;
    }

    // å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹ï¼Œå†æ˜¾ç¤ºæ–‡ä»¶
    const folders = structure.filter(item => item.is_dir);
    const files = structure.filter(item => !item.is_dir);

    // æ˜¾ç¤ºæ–‡ä»¶å¤¹
    folders.forEach(folder => {
        const folderItem = document.createElement('div');
        folderItem.className = 'file-item';

        const currentPath = getCurrentPath();
        const folderPath = currentPath ? `${currentPath}/${folder.name}` : folder.name;

        folderItem.innerHTML = `
            <span class="folder-item" data-path="${folderPath}">ğŸ“ ${folder.name}</span>
            <div class="file-actions">
                <button class="build-btn" data-path="${folderPath}">Build</button>
            </div>
        `;
        listContainer.appendChild(folderItem);
    });

    // æ˜¾ç¤ºæ–‡ä»¶ - æ‰©å±•æ”¯æŒçš„æ–‡ä»¶ç±»å‹
    files.forEach(file => {
        // å®šä¹‰å…è®¸çš„æ–‡ä»¶æ‰©å±•å
        const allowedExtensions = ['.txt', '.md', '.rst', '.csv', '.xlsx', '.xls', '.docx', '.doc','.pdf'];
        const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));

        // ç¡®ä¿æ–‡ä»¶æœ‰æ‰©å±•åä¸”åœ¨å…è®¸åˆ—è¡¨ä¸­
        if (ext && allowedExtensions.includes(ext)) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';

            const currentPath = getCurrentPath();
            const filePath = currentPath;

            fileItem.innerHTML = `
                <span class="file-name">ğŸ“„ ${file.name}</span>
                <div class="file-actions">
                    <button class="edit-btn" data-file="${file.name}" data-path="${filePath}">ç¼–è¾‘</button>
                    <button class="delete-btn" data-file="${file.name}" data-path="${filePath}">åˆ é™¤</button>
                </div>
            `;
            listContainer.appendChild(fileItem);
        }
    });

    // ç»‘å®šæ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', () => {
            const path = item.getAttribute('data-path');
            loadStructure(path);
        });
    });

    // ç»‘å®šbuildæŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.build-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const folderPath = e.target.getAttribute('data-path');

            if (confirm(`ç¡®å®šè¦ç¼–è¯‘æ–‡ä»¶å¤¹ "${folderPath}" å—ï¼Ÿ`)) {
                try {
                    const response = await fetch('/build-folder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ folder_path: folderPath })
                    });

                    const result = await response.json();
                    if (result.error) {
                        alert(result.error);
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    alert('ç¼–è¯‘å¤±è´¥: ' + error.message);
                }
            }
        });
    });

    // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const filename = e.target.getAttribute('data-file');
            const filepath = e.target.getAttribute('data-path');
            await editFile(filename, filepath);
        });
    });

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const filename = e.target.getAttribute('data-file');
            const filepath = e.target.getAttribute('data-path');

            const fullPath = filepath ? `${filepath}/${filename}` : filename;

            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${fullPath} å—?`)) {
                await deleteFile(fullPath);
            }
        });
    });
}

// ç¼–è¾‘æ–‡ä»¶
async function editFile(filename, filepath) {
    try {
        const fullPath = filepath ? `${filepath}/${filename}` : filename;
        const response = await fetch(`/get-financial-file?filename=${encodeURIComponent(fullPath)}`);
        const result = await response.json();

        if (result.error) {
            alert(result.error);
            return;
        }

        document.getElementById('edit-filename').value = filename;
        document.getElementById('edit-filepath').value = filepath;
        document.getElementById('file-content').value = result.content;
        document.getElementById('edit-section').classList.remove('hidden');
    } catch (error) {
        alert('åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥: ' + error.message);
    }
}

// åˆ é™¤æ–‡ä»¶
async function deleteFile(filename) {
    try {
        const response = await fetch('/delete-financial-file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ filename: filename })
        });

        const result = await response.json();
        if (result.error) {
            alert(result.error);
        } else {
            alert('æ–‡ä»¶å·²åˆ é™¤');
            loadStructure(getCurrentPath());
        }
    } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}
    </script>
</body>
</html>