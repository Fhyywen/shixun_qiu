<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间序列预测算法知识库</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>时间序列预测算法知识库问答系统</h1>
            <p>提问关于ARIMA、Prophet、LSTM等时间序列预测算法的问题</p>
        </header>

        <main>
            <!-- 问答区域 -->
            <form id="question-form">
                <div class="knowledge-base-selector">
                    <label for="knowledge-base-path">选择知识库路径:</label>
                    <input type="text" id="knowledge-base-path" placeholder="例如: /data/knowledge_base" autocomplete="off">
                    <button type="button" id="use-default-kb">清空路径</button>
                    <button type="button" id="get-current-kb">默认路径</button>
                    <button type="button" id="browse-kb">浏览...</button> <!-- 新增按钮 -->
                </div>
                <div class="input-group">
                    <input type="text" id="question-input" placeholder="请输入关于时间序列预测算法的问题..." autocomplete="off">
                    <button type="submit">提问</button>
                </div>
            </form>

            <div id="answer-container">
                <div id="answer"></div>
                <div id="references"></div>
            </div>

            <div id="loading" class="hidden">
                <p>正在思考中...</p>
            </div>

            <!-- 文件管理区域 -->
            <div class="file-manager">
                <div class="files-section">
                    <h3>知识库结构</h3>
                    <div id="structure-path">
                        <span class="path-item" data-path="">根目录</span>
                    </div>
                    <div id="folder-upload" class="upload-section hidden">
                        <h4>上传文件到当前目录</h4>
                            <form id="folder-upload-form" enctype="multipart/form-data">
                                <input type="file" id="folder-file-upload" accept=".txt,.md,.rst,.csv,.xlsx,.xls,.docx,.pdf" />
                                <button type="submit">上传</button>
                            </form>

                            <div class="new-folder-section">
                                <h4>新建文件夹</h4>
                                <input type="text" id="new-folder-name" placeholder="请输入文件夹名称">
                                <button id="create-folder-btn">创建</button>
                            </div>
                    </div>

                    <div id="structure-list">
                        <!-- 目录结构将通过JS动态加载 -->
                    </div>
                </div>

                <!-- 文件编辑区域 -->
                <div class="edit-section hidden" id="edit-section">
                    <h3>编辑文件</h3>
                    <input type="hidden" id="edit-filename" />
                    <input type="hidden" id="edit-filepath" />
                    <textarea id="file-content" rows="10"></textarea>
                    <div class="edit-buttons">
                        <button id="save-edit">保存</button>
                        <button id="cancel-edit">取消</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 页面加载时获取当前知识库路径
        document.addEventListener('DOMContentLoaded', () => {
            // 加载目录结构
            loadStructure();

            // 获取当前知识库路径并显示
            getCurrentKnowledgeBase();

            // 绑定知识库路径相关按钮事件
            document.getElementById('use-default-kb').addEventListener('click', () => {
                document.getElementById('knowledge-base-path').value = '';
            });

            document.getElementById('get-current-kb').addEventListener('click', getCurrentKnowledgeBase);

            // 绑定浏览知识库路径按钮事件
            document.getElementById('browse-kb').addEventListener('click', showKnowledgeBaseBrowser);
        });

        // 修复当前路径按钮功能
        async function getCurrentKnowledgeBase() {
            try {
                const response = await fetch('/get_knowledge_base');
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                const data = await response.json();
                if (data.knowledge_base) {
                    document.getElementById('knowledge-base-path').value = data.knowledge_base;
                } else {
                    alert('未获取到当前知识库路径');
                }
            } catch (error) {
                console.error('获取当前知识库路径失败:', error);
                alert('获取当前路径失败: ' + error.message);
            }
        }

        // 问答功能 - 修改为包含知识库路径
        document.getElementById('question-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const questionInput = document.getElementById('question-input');
            const knowledgeBaseInput = document.getElementById('knowledge-base-path');

            const question = questionInput.value.trim();
            const knowledgeBasePath = knowledgeBaseInput.value.trim();

            if (!question) return;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('answer').innerHTML = '';
            document.getElementById('references').innerHTML = '';

            try {
                // 准备请求数据
                const formData = new URLSearchParams();
                formData.append('question', question);
                if (knowledgeBasePath) {
                    formData.append('knowledge_base_path', knowledgeBasePath);
                }

                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    document.getElementById('answer').innerHTML = `<p class="error">${data.error}</p>`;
                } else {
                    // 显示回答和使用的知识库路径
                    let answerHtml = `<p>${data.answer.replace(/\n/g, '<br>')}</p>`;
                    if (data.knowledge_base_used) {
                        answerHtml += `<p class="knowledge-base-used">使用的知识库: ${data.knowledge_base_used}</p>`;
                    }
                    document.getElementById('answer').innerHTML = answerHtml;

                    if (data.sources && data.sources.length > 0) {
                        let referencesHtml = '<h3>参考来源:</h3><ul>';
                        data.sources.forEach(source => {
                            referencesHtml += `<li>${source.title} (相似度: ${(1 - source.distance).toFixed(3)})</li>`;
                        });
                        referencesHtml += '</ul>';
                        document.getElementById('references').innerHTML = referencesHtml;
                    }
                }
            } catch (error) {
                document.getElementById('answer').innerHTML = `<p class="error">请求失败: ${error.message}</p>`;
            } finally {
                document.getElementById('loading').classList.add('hidden');
                questionInput.value = '';
            }
        });

        // 文件管理相关JS代码
        // 文件夹内上传文件表单提交
        document.getElementById('folder-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('folder-file-upload');
            if (!fileInput.files.length) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('folder_path', getCurrentPath());

            try {
                const response = await fetch('/upload-financial-file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('文件上传成功');
                    loadStructure(getCurrentPath());
                    fileInput.value = '';
                }
            } catch (error) {
                alert('上传失败: ' + error.message);
            }
        });

        // 取消编辑
        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('edit-section').classList.add('hidden');
            document.getElementById('edit-filename').value = '';
            document.getElementById('edit-filepath').value = '';
            document.getElementById('file-content').value = '';
        });

        // 保存编辑
        document.getElementById('save-edit').addEventListener('click', async () => {
            const filename = document.getElementById('edit-filename').value;
            const filepath = document.getElementById('edit-filepath').value;
            const content = document.getElementById('file-content').value;

            if (!filename || !content) return;

            const fullPath = filepath ? `${filepath}/${filename}` : filename;

            try {
                const response = await fetch('/save-financial-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: fullPath,
                        content: content
                    })
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('文件保存成功');
                    document.getElementById('edit-section').classList.add('hidden');
                    loadStructure(getCurrentPath());
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        });

        // 新建文件夹按钮点击事件
        document.getElementById('create-folder-btn').addEventListener('click', async () => {
            const folderName = document.getElementById('new-folder-name').value.trim();
            if (!folderName) {
                alert('请输入文件夹名称');
                return;
            }

            if (/[<>:"/\\|?*]/.test(folderName)) {
                alert('文件夹名称不能包含以下字符: < > : " / \\ | ? *');
                return;
            }

            const currentPath = getCurrentPath();

            try {
                const response = await fetch('/create-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_name: folderName,
                        parent_path: currentPath
                    })
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('文件夹创建成功');
                    document.getElementById('new-folder-name').value = '';
                    loadStructure(currentPath);
                }
            } catch (error) {
                alert('创建文件夹失败: ' + error.message);
            }
        });

        function getCurrentPath() {
            const pathItems = document.querySelectorAll('#structure-path .path-item');
            if (pathItems.length === 0) return '';

            const lastItem = pathItems[pathItems.length - 1];
            return lastItem.getAttribute('data-path') || '';
        }

        async function loadStructure(path = '') {
            try {
                const response = await fetch('/list-financial-structure');
                const structure = await response.json();

                if (structure.error) {
                    document.getElementById('structure-list').innerHTML = `<p class="error">${structure.error}</p>`;
                    return;
                }

                updatePathNavigation(path);

                const uploadSection = document.getElementById('folder-upload');
                if (path || structure.length > 0) {
                    uploadSection.classList.remove('hidden');
                } else {
                    uploadSection.classList.add('hidden');
                }

                const currentStructure = findStructureByPath(structure, path);
                renderStructureList(currentStructure);
            } catch (error) {
                console.error('加载目录结构失败:', error);
            }
        }

        function updatePathNavigation(currentPath) {
            const pathContainer = document.getElementById('structure-path');
            pathContainer.innerHTML = '';

            const rootItem = document.createElement('span');
            rootItem.className = 'path-item';
            rootItem.setAttribute('data-path', '');
            rootItem.textContent = '根目录';
            rootItem.addEventListener('click', () => loadStructure(''));
            pathContainer.appendChild(rootItem);

            if (!currentPath) return;

            const pathParts = currentPath.split('/');
            let fullPath = '';

            pathParts.forEach((part, index) => {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                pathContainer.appendChild(separator);

                fullPath = index === 0 ? part : `${fullPath}/${part}`;

                const pathItem = document.createElement('span');
                pathItem.className = 'path-item';
                pathItem.setAttribute('data-path', fullPath);
                pathItem.setAttribute('data-name', part);
                pathItem.textContent = part;

                (function(currentFullPath) {
                    pathItem.addEventListener('click', () => {
                        loadStructure(currentFullPath);
                    });
                })(fullPath);

                pathContainer.appendChild(pathItem);
            });
        }

        function findStructureByPath(structure, path) {
            if (!path) return structure;

            const pathParts = path.split('/');
            let currentStructure = structure;

            for (const part of pathParts) {
                const found = currentStructure.find(item => item.name === part && item.is_dir);
                if (!found) return [];
                currentStructure = found.children;
            }

            return currentStructure;
        }

        function renderStructureList(structure) {
            const listContainer = document.getElementById('structure-list');
            listContainer.innerHTML = '';

            if (structure.length === 0) {
                listContainer.innerHTML = '<p>该目录下没有文件或文件夹</p>';
                return;
            }

            const folders = structure.filter(item => item.is_dir);
            const files = structure.filter(item => !item.is_dir);

            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'file-item';

                const currentPath = getCurrentPath();
                const folderPath = currentPath ? `${currentPath}/${folder.name}` : folder.name;

                folderItem.innerHTML = `
                    <span class="folder-item" data-path="${folderPath}">📁 ${folder.name}</span>
                    <div class="file-actions">
                        <button class="build-btn" data-path="${folderPath}">Build</button>
                    </div>
                `;
                listContainer.appendChild(folderItem);
            });

            files.forEach(file => {
                const allowedExtensions = ['.txt', '.md', '.rst', '.csv', '.xlsx', '.xls', '.docx', '.doc','.pdf'];
                const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));

                if (ext && allowedExtensions.includes(ext)) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';

                    const currentPath = getCurrentPath();
                    const filePath = currentPath;

                    fileItem.innerHTML = `
                        <span class="file-name">📄 ${file.name}</span>
                        <div class="file-actions">
                            <button class="edit-btn" data-file="${file.name}" data-path="${filePath}">编辑</button>
                            <button class="delete-btn" data-file="${file.name}" data-path="${filePath}">删除</button>
                        </div>
                    `;
                    listContainer.appendChild(fileItem);
                }
            });

            document.querySelectorAll('.folder-item').forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.getAttribute('data-path');
                    loadStructure(path);
                });
            });

            document.querySelectorAll('.build-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const folderPath = e.target.getAttribute('data-path');

                    if (confirm(`确定要编译文件夹 "${folderPath}" 吗？`)) {
                        try {
                            const response = await fetch('/build-folder', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ folder_path: folderPath })
                            });

                            const result = await response.json();
                            if (result.error) {
                                alert(result.error);
                            } else {
                                alert(result.message);
                            }
                        } catch (error) {
                            alert('编译失败: ' + error.message);
                        }
                    }
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const filename = e.target.getAttribute('data-file');
                    const filepath = e.target.getAttribute('data-path');
                    await editFile(filename, filepath);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const filename = e.target.getAttribute('data-file');
                    const filepath = e.target.getAttribute('data-path');

                    const fullPath = filepath ? `${filepath}/${filename}` : filename;

                    if (confirm(`确定要删除 ${fullPath} 吗?`)) {
                        await deleteFile(fullPath);
                    }
                });
            });
        }

        async function editFile(filename, filepath) {
            try {
                const fullPath = filepath ? `${filepath}/${filename}` : filename;
                const response = await fetch(`/get-financial-file?filename=${encodeURIComponent(fullPath)}`);
                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                    return;
                }

                document.getElementById('edit-filename').value = filename;
                document.getElementById('edit-filepath').value = filepath;
                document.getElementById('file-content').value = result.content;
                document.getElementById('edit-section').classList.remove('hidden');
            } catch (error) {
                alert('加载文件内容失败: ' + error.message);
            }
        }

        async function deleteFile(filename) {
            try {
                const response = await fetch('/delete-financial-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: filename })
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('文件已删除');
                    loadStructure(getCurrentPath());
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }
        // 新增：显示知识库浏览器
        function showKnowledgeBaseBrowser() {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'kb-browser-modal';
            modal.innerHTML = `
                <div class="kb-browser-content">
                    <h3>选择知识库路径</h3>
                    <div id="kb-browser-path">
                        <span class="path-item" data-path="">根目录</span>
                    </div>
                    <div id="kb-browser-list"></div>
                    <div class="modal-buttons">
                        <button id="select-kb-path">选择此路径</button>
                        <button id="close-kb-browser">取消</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const basePath = '/data/knowledge_base/';
            // 加载根目录结构
            loadKbBrowserStructure('', modal);

            // 绑定按钮事件
            document.getElementById('close-kb-browser').addEventListener('click', () => {
                modal.remove();
            });

            document.getElementById('select-kb-path').addEventListener('click', () => {
                const currentPath = getKbBrowserCurrentPath(modal);
                const fullPath = basePath + (currentPath ? currentPath : '');
                document.getElementById('knowledge-base-path').value = fullPath;
                modal.remove();
            });
        }

        // 加载知识库浏览器的目录结构
        async function loadKbBrowserStructure(path = '', modal) {
            try {
                const response = await fetch('/list-financial-structure');
                const structure = await response.json();

                if (structure.error) {
                    modal.querySelector('#kb-browser-list').innerHTML = `<p class="error">${structure.error}</p>`;
                    return;
                }

                updateKbBrowserPathNavigation(path, modal);

                const currentStructure = findStructureByPath(structure, path);
                renderKbBrowserStructureList(currentStructure, path, modal);
            } catch (error) {
                console.error('加载目录结构失败:', error);
            }
        }

        // 更新知识库浏览器的路径导航
        function updateKbBrowserPathNavigation(currentPath, modal) {
            const pathContainer = modal.querySelector('#kb-browser-path');
            pathContainer.innerHTML = '';

            const rootItem = document.createElement('span');
            rootItem.className = 'path-item';
            rootItem.setAttribute('data-path', '');
            rootItem.textContent = '根目录';
            rootItem.addEventListener('click', () => loadKbBrowserStructure('', modal));
            pathContainer.appendChild(rootItem);

            if (!currentPath) return;

            const pathParts = currentPath.split('/');
            let fullPath = '';

            pathParts.forEach((part, index) => {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                pathContainer.appendChild(separator);

                fullPath = index === 0 ? part : `${fullPath}/${part}`;

                const pathItem = document.createElement('span');
                pathItem.className = 'path-item';
                pathItem.setAttribute('data-path', fullPath);
                pathItem.textContent = part;
                pathItem.addEventListener('click', () => loadKbBrowserStructure(fullPath, modal));

                pathContainer.appendChild(pathItem);
            });
        }

        // 渲染知识库浏览器的目录列表
        function renderKbBrowserStructureList(structure, currentPath, modal) {
            const listContainer = modal.querySelector('#kb-browser-list');
            listContainer.innerHTML = '';

            if (structure.length === 0) {
                listContainer.innerHTML = '<p>该目录下没有文件夹</p>';
                return;
            }

            // 只显示文件夹
            const folders = structure.filter(item => item.is_dir);

            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'kb-browser-folder';

                const folderPath = currentPath ? `${currentPath}/${folder.name}` : folder.name;

                folderItem.innerHTML = `📁 ${folder.name}`;
                folderItem.setAttribute('data-path', folderPath);
                folderItem.addEventListener('click', () => {
                    loadKbBrowserStructure(folderPath, modal);
                });

                listContainer.appendChild(folderItem);
            });
        }

        // 获取知识库浏览器当前路径
        function getKbBrowserCurrentPath(modal) {
            const pathItems = modal.querySelectorAll('#kb-browser-path .path-item');
            if (pathItems.length === 0) return '';

            const lastItem = pathItems[pathItems.length - 1];
            return lastItem.getAttribute('data-path') || '';
        }
    </script>
</body>
</html>