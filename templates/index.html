<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çŸ¥è¯†åº“</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ</h1>
            <p>æé—®å…³äºARIMAã€Prophetã€LSTMç­‰æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çš„é—®é¢˜</p>
        </header>

        <main>
            <!-- ä¼šè¯ç®¡ç†åŒºåŸŸ -->
            <div class="session-management">
                <div class="session-controls">
                    <button id="new-session-btn">æ–°å»ºä¼šè¯</button>
                    <button id="show-sessions-btn">ä¼šè¯åˆ—è¡¨</button>
                    <span id="current-session-info">å½“å‰ä¼šè¯: æ— </span>
                </div>

                <!-- ä¼šè¯åˆ—è¡¨æ¨¡æ€æ¡† -->
                <div id="sessions-modal" class="modal hidden">
                    <div class="modal-content">
                        <h3>ä¼šè¯åˆ—è¡¨</h3>
                        <div id="sessions-list"></div>
                        <div class="modal-buttons">
                            <button id="close-sessions-modal">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="template-upload-section">
                <h4>ä¸Šä¼ å›ç­”æ¨¡æ¿æ–‡ä»¶</h4>
                <form id="template-upload-form" enctype="multipart/form-data">
                    <input type="file" id="template-file-upload"
                           accept=".txt,.md,.rst,.csv,.xlsx,.xls,.docx,.pdf" />
                    <button type="submit">ä¸Šä¼ æ¨¡æ¿</button>
                    <p class="template-info">ä¸Šä¼ åå°†æ›¿æ¢å½“å‰å›ç­”æ¨¡æ¿ï¼Œæ”¯æŒå¤šç§æ ¼å¼</p>
                </form>
            </div>

            <!-- é—®ç­”åŒºåŸŸ -->
            <form id="question-form">
                <div class="knowledge-base-selector">
                    <label for="knowledge-base-path">é€‰æ‹©çŸ¥è¯†åº“è·¯å¾„:</label>
                    <input type="text" id="knowledge-base-path" placeholder="ä¾‹å¦‚: /data/knowledge_base" autocomplete="off">
                    <button type="button" id="use-default-kb">æ¸…ç©ºè·¯å¾„</button>
                    <button type="button" id="get-current-kb">é»˜è®¤è·¯å¾„</button>
                    <button type="button" id="browse-kb">æµè§ˆ...</button>
                </div>
                <div class="input-group">
                    <input type="text" id="question-input" placeholder="è¯·è¾“å…¥å…³äºæ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çš„é—®é¢˜..." autocomplete="off">
                    <button type="submit">æé—®</button>
                </div>
            </form>

            <div id="loading-container" class="hidden">
                <div id="loading">
                    <p>æ­£åœ¨æ€è€ƒä¸­...</p>
                </div>
            </div>

            <!-- å¯¹è¯å†å²æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="conversation-history" class="hidden">
                <h3>å¯¹è¯å†å²</h3>
                <div id="history-messages"></div>
            </div>

            <div id="answer-container">
                <div id="answer"></div>
                <div id="references"></div>
                <div class="download-section" style="margin-top: 20px; text-align: right;">
                    <button id="download-word" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                        ä¸‹è½½Wordæ ¼å¼å›ç­”
                    </button>
                </div>
            </div>

            <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
            <div class="file-manager">
                <div class="files-section">
                    <h3>çŸ¥è¯†åº“ç»“æ„</h3>
                    <div id="structure-path">
                        <span class="path-item" data-path="">æ ¹ç›®å½•</span>
                    </div>
                    <div id="folder-upload" class="upload-section hidden">
                        <h4>ä¸Šä¼ æ–‡ä»¶åˆ°å½“å‰ç›®å½•</h4>
                        <form id="folder-upload-form" enctype="multipart/form-data">
                            <input type="file" id="folder-file-upload" accept=".txt,.md,.rst,.csv,.xlsx,.xls,.docx,.pdf" multiple/>
                            <button type="submit">ä¸Šä¼ </button>
                        </form>

                        <div class="new-folder-section">
                            <h4>æ–°å»ºæ–‡ä»¶å¤¹</h4>
                            <input type="text" id="new-folder-name" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
                            <button id="create-folder-btn">åˆ›å»º</button>
                        </div>
                    </div>

                    <div id="structure-list">
                        <!-- ç›®å½•ç»“æ„å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </main>
    </div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentSessionId = '';
        let currentUserId = 'user_' + Math.random().toString(36).substr(2, 9); // ç”Ÿæˆéšæœºç”¨æˆ·ID
        let fullAnswerContent = '';
        let fullReferencesContent = '';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            bindEvents();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            loadStructure();
            getCurrentKnowledgeBase();
            // è‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯
            createNewSession();
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ä¼šè¯ç®¡ç†äº‹ä»¶
            document.getElementById('new-session-btn').addEventListener('click', createNewSession);
            document.getElementById('show-sessions-btn').addEventListener('click', showSessionsModal);
            document.getElementById('close-sessions-modal').addEventListener('click', closeSessionsModal);

            // çŸ¥è¯†åº“è·¯å¾„äº‹ä»¶
            document.getElementById('use-default-kb').addEventListener('click', () => {
                document.getElementById('knowledge-base-path').value = '';
            });
            document.getElementById('get-current-kb').addEventListener('click', getCurrentKnowledgeBase);
            document.getElementById('browse-kb').addEventListener('click', showKnowledgeBaseBrowser);

            // é—®ç­”è¡¨å•äº‹ä»¶
            document.getElementById('question-form').addEventListener('submit', handleQuestionSubmit);

            // ä¸‹è½½äº‹ä»¶
            document.getElementById('download-word').addEventListener('click', downloadAsWord);

            // æ–‡ä»¶ç®¡ç†äº‹ä»¶
            document.getElementById('folder-upload-form').addEventListener('submit', handleFileUpload);
            document.getElementById('template-upload-form').addEventListener('submit', handleTemplateUpload);
            document.getElementById('create-folder-btn').addEventListener('click', handleCreateFolder);
        }

        // ä¼šè¯ç®¡ç†å‡½æ•°
        async function createNewSession() {
            try {
                const knowledgeBasePath = document.getElementById('knowledge-base-path').value.trim();
                const response = await fetch('/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        knowledge_base_path: knowledgeBasePath,
                        title: 'æ–°å¯¹è¯'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    currentSessionId = result.session_id;
                    updateSessionInfo();
                    clearConversation();
                    loadConversationHistory();
                    alert('æ–°ä¼šè¯å·²åˆ›å»º');
                } else {
                    throw new Error(result.error || 'åˆ›å»ºä¼šè¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
                alert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message);
            }
        }

        async function showSessionsModal() {
            try {
                const response = await fetch(`/sessions?user_id=${currentUserId}`);
                const result = await response.json();

                if (result.success) {
                    renderSessionsList(result.sessions);
                    document.getElementById('sessions-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        function closeSessionsModal() {
            document.getElementById('sessions-modal').classList.add('hidden');
        }

        function renderSessionsList(sessions) {
            const container = document.getElementById('sessions-list');
            container.innerHTML = '';

            if (sessions.length === 0) {
                container.innerHTML = '<p>æš‚æ— ä¼šè¯</p>';
                return;
            }

            sessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                if (session.session_id === currentSessionId) {
                    sessionItem.classList.add('active');
                }

                sessionItem.innerHTML = `
                    <div class="session-info">
                        <strong>${session.title || 'æ— æ ‡é¢˜'}</strong>
                        <span class="session-date">${new Date(session.updated_at).toLocaleString()}</span>
                        <span class="session-kb">çŸ¥è¯†åº“: ${session.knowledge_base_path || 'é»˜è®¤'}</span>
                    </div>
                    <div class="session-actions">
                        <button class="switch-session-btn" data-session-id="${session.session_id}">åˆ‡æ¢</button>
                        <button class="view-history-btn" data-session-id="${session.session_id}">æŸ¥çœ‹</button>
                        <button class="delete-session-btn" data-session-id="${session.session_id}">åˆ é™¤</button>
                    </div>
                `;

                container.appendChild(sessionItem);
            });

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.switch-session-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sessionId = e.target.getAttribute('data-session-id');
                    switchSession(sessionId);
                });
            });

            document.querySelectorAll('.view-history-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sessionId = e.target.getAttribute('data-session-id');
                    viewSessionHistory(sessionId);
                });
            });

            document.querySelectorAll('.delete-session-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sessionId = e.target.getAttribute('data-session-id');
                    deleteSession(sessionId);
                });
            });
        }

        async function switchSession(sessionId) {
            try {
                currentSessionId = sessionId;
                updateSessionInfo();
                loadConversationHistory();
                closeSessionsModal();
                alert('å·²åˆ‡æ¢åˆ°é€‰å®šä¼šè¯');
            } catch (error) {
                console.error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', error);
            }
        }

        async function viewSessionHistory(sessionId) {
            try {
                const response = await fetch(`/sessions/${sessionId}/messages`);
                const result = await response.json();

                if (result.success) {
                    displaySessionHistory(result.messages);
                }
            } catch (error) {
                console.error('è·å–ä¼šè¯å†å²å¤±è´¥:', error);
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;

            try {
                const response = await fetch('/sessions', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });

                const result = await response.json();
                if (result.success) {
                    if (sessionId === currentSessionId) {
                        createNewSession(); // åˆ›å»ºæ–°ä¼šè¯æ›¿ä»£è¢«åˆ é™¤çš„ä¼šè¯
                    }
                    showSessionsModal(); // åˆ·æ–°åˆ—è¡¨
                }
            } catch (error) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
            }
        }

        function updateSessionInfo() {
            const infoElement = document.getElementById('current-session-info');
            infoElement.textContent = `å½“å‰ä¼šè¯: ${currentSessionId.substring(0, 8)}...`;
        }

        async function loadConversationHistory() {
            if (!currentSessionId) return;

            try {
                const response = await fetch(`/sessions/${currentSessionId}/messages?limit=10`);
                const result = await response.json();

                if (result.success && result.messages.length > 0) {
                    document.getElementById('conversation-history').classList.remove('hidden');
                    displaySessionHistory(result.messages);
                } else {
                    document.getElementById('conversation-history').classList.add('hidden');
                }
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
            }
        }

        function displaySessionHistory(messages) {
            const container = document.getElementById('history-messages');
            container.innerHTML = '';

            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.role}`;

                const content = message.role === 'user' ?
                    `é—®: ${message.content}` :
                    `ç­”: ${message.content.substring(0, 100)}...`;

                messageElement.textContent = content;
                container.appendChild(messageElement);
            });
        }

        function clearConversation() {
            document.getElementById('answer').innerHTML = '';
            document.getElementById('references').innerHTML = '';
            document.getElementById('conversation-history').classList.add('hidden');
            document.getElementById('download-word').style.display = 'none';
        }

        // ä¿®æ”¹é—®ç­”å¤„ç†å‡½æ•°
        async function handleQuestionSubmit(e) {
            e.preventDefault();

            const questionInput = document.getElementById('question-input');
            const knowledgeBaseInput = document.getElementById('knowledge-base-path');
            const question = questionInput.value.trim();
            const knowledgeBasePath = knowledgeBaseInput.value.trim();

            if (!question) return;

            // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œå…ˆåˆ›å»º
            if (!currentSessionId) {
                await createNewSession();
            }

            // é‡ç½®çŠ¶æ€
            clearConversation();
            document.getElementById('loading-container').classList.remove('hidden');
            document.getElementById('answer-container').classList.remove('hidden');

            try {
                fullAnswerContent = '';
                fullReferencesContent = '';

                // ä½¿ç”¨JSONæ ¼å¼å‘é€è¯·æ±‚ï¼ŒåŒ…å«ä¼šè¯ä¿¡æ¯
                const requestData = {
                    question: question,
                    knowledge_base_path: knowledgeBasePath,
                    session_id: currentSessionId,
                    user_id: currentUserId,
                    new_session: false
                };

                const response = await fetch('/ask_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                await processStreamResponse(response);

            } catch (error) {
                document.getElementById('answer').innerHTML = `<p class="error">è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            } finally {
                document.getElementById('loading-container').classList.add('hidden');
                questionInput.value = '';
                // é‡æ–°åŠ è½½å¯¹è¯å†å²
                loadConversationHistory();
            }
        }

        // æµå¼å“åº”å¤„ç†
        async function processStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            let mdContent = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });

                let idx;
                while ((idx = buffer.indexOf('\n\n')) !== -1) {
                    const rawFrame = buffer.slice(0, idx).trim();
                    buffer = buffer.slice(idx + 2);

                    if (!rawFrame.startsWith('data:')) continue;

                    const payload = rawFrame.slice(5);
                    let frame;
                    try {
                        frame = JSON.parse(payload);
                    } catch {
                        continue;
                    }

                    if (frame.type === 'start') {
                        console.log('å¼€å§‹æ¥æ”¶æµå¼å“åº”ï¼Œä¼šè¯ID:', frame.session_id);
                    } else if (frame.type === 'chunk') {
                        mdContent += frame.content || '';
                        document.getElementById('answer').innerHTML = marked.parse(mdContent);
                        document.getElementById('answer').scrollTop = document.getElementById('answer').scrollHeight;
                    } else if (frame.type === 'end') {
                        handleEndFrame(frame);
                    }
                }
            }
        }

        function handleEndFrame(frame) {
            // æ›´æ–°ä¼šè¯ä¿¡æ¯
            if (frame.session_id && frame.session_id !== currentSessionId) {
                currentSessionId = frame.session_id;
                updateSessionInfo();
            }

            // æ·»åŠ çŸ¥è¯†åº“ä¿¡æ¯
            if (frame.knowledge_base_used) {
                const kbInfo = document.createElement('p');
                kbInfo.className = 'knowledge-base-used';
                kbInfo.textContent = `ä½¿ç”¨çš„çŸ¥è¯†åº“: ${frame.knowledge_base_used}`;
                document.getElementById('answer').appendChild(kbInfo);
            }

            // æ·»åŠ å‚è€ƒæ¥æº
            const sources = frame.sources || [];
            if (sources.length > 0) {
                const ul = document.createElement('ul');
                const title = document.createElement('h3');
                title.textContent = 'å‚è€ƒæ¥æº:';
                document.getElementById('references').appendChild(title);

                sources.forEach(s => {
                    const li = document.createElement('li');
                    const sim = (s.similarity !== undefined) ? s.similarity : (s.distance !== undefined ? (1 - s.distance) : undefined);
                    const text = s.title ? `${s.title}${sim !== undefined ? ` (ç›¸ä¼¼åº¦: ${sim.toFixed(3)})` : ''}` :
                                 (s.content ? s.content.slice(0, 60) + '...' : JSON.stringify(s));
                    li.textContent = text;
                    ul.appendChild(li);
                });
                document.getElementById('references').appendChild(ul);
            }

            // æ·»åŠ ç½‘ç»œæœç´¢å‚è€ƒé“¾æ¥
            const webSources = frame.web_sources || [];
            if (webSources.length > 0) {
                const ul = document.createElement('ul');
                const title = document.createElement('h3');
                title.textContent = 'å‚è€ƒé“¾æ¥:';
                document.getElementById('references').appendChild(title);

                webSources.forEach((source, index) => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = source.link;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.textContent = `[${index + 1}] ${source.title}`;
                    li.appendChild(a);
                    ul.appendChild(li);
                });
                document.getElementById('references').appendChild(ul);
            }

            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            document.getElementById('download-word').style.display = 'inline-block';
        }

        // åŸæœ‰çš„æ–‡ä»¶ç®¡ç†å‡½æ•°ä¿æŒä¸å˜
        async function getCurrentKnowledgeBase() {
            try {
                const response = await fetch('/get_knowledge_base');
                const data = await response.json();
                if (data.knowledge_base) {
                    document.getElementById('knowledge-base-path').value = data.knowledge_base;
                }
            } catch (error) {
                console.error('è·å–å½“å‰çŸ¥è¯†åº“è·¯å¾„å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹ä¸‹è½½åŠŸèƒ½çš„JavaScriptä»£ç  - æ”¹ä¸ºä¸‹è½½Wordæ–‡æ¡£
        function downloadAsWord() {
            // è·å–å½“å‰ç”Ÿæˆçš„å›ç­”å†…å®¹å’Œå‚è€ƒæ¥æº
            const answerContent = document.getElementById('answer').innerText;
            const referencesContent = document.getElementById('references').innerText;

            // åˆ›å»ºWordæ–‡æ¡£å†…å®¹
            const docContent = `
æ—¶é—´åºåˆ—é¢„æµ‹ç®—æ³•çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ

å›ç­”å†…å®¹:
${answerContent}

${referencesContent}

ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
            `;

            // åˆ›å»ºBlobå¯¹è±¡å¹¶ç”Ÿæˆä¸‹è½½é“¾æ¥
            const blob = new Blob([docContent], { type: 'application/msword;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `answer-${timestamp}.doc`;
            document.body.appendChild(a);
            a.click();

            // æ¸…ç†èµ„æº
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // æ–‡ä»¶ç®¡ç†ç›¸å…³JSä»£ç 
        // æ–‡ä»¶å¤¹å†…ä¸Šä¼ æ–‡ä»¶è¡¨å•æäº¤
        // ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ è¡¨å•æäº¤äº‹ä»¶å¤„ç†
        document.getElementById('folder-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('folder-file-upload');
            if (!fileInput.files.length) return;

            const formData = new FormData();
            const currentPath = getCurrentPath();

            // å¾ªç¯æ·»åŠ æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('file', fileInput.files[i]);
            }
            formData.append('folder_path', currentPath);

            try {
                const response = await fetch('/upload-financial-file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert(`æˆåŠŸä¸Šä¼  ${result.count} ä¸ªæ–‡ä»¶`);
                    loadStructure(getCurrentPath());
                    fileInput.value = '';
                }
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        });

        // æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ å¤„ç† - ä¿®å¤é€‰æ‹©å™¨
        document.querySelector('#template-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('template-file-upload');
            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©æ¨¡æ¿æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('template_file', fileInput.files[0]);

            try {
                const response = await fetch('/upload-template', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.error) {
                    alert(`ä¸Šä¼ å¤±è´¥: ${result.error}`);
                } else {
                    alert('æ¨¡æ¿ä¸Šä¼ æˆåŠŸï¼Œå·²åº”ç”¨æ–°æ¨¡æ¿');
                    // æ¸…ç©ºè¾“å…¥
                    fileInput.value = '';
                }
            } catch (error) {
                alert('æ¨¡æ¿ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        });

        // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('create-folder-btn').addEventListener('click', async () => {
            const folderName = document.getElementById('new-folder-name').value.trim();
            if (!folderName) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
                return;
            }

            if (/[<>:"/\\|?*]/.test(folderName)) {
                alert('æ–‡ä»¶å¤¹åç§°ä¸èƒ½åŒ…å«ä»¥ä¸‹å­—ç¬¦: < > : " / \\ | ? *');
                return;
            }

            const currentPath = getCurrentPath();

            try {
                const response = await fetch('/create-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_name: folderName,
                        parent_path: currentPath
                    })
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                    document.getElementById('new-folder-name').value = '';
                    loadStructure(currentPath);
                }
            } catch (error) {
                alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
            }
        });

        function getCurrentPath() {
            const pathItems = document.querySelectorAll('#structure-path .path-item');
            if (pathItems.length === 0) return '';

            const lastItem = pathItems[pathItems.length - 1];
            return lastItem.getAttribute('data-path') || '';
        }

        async function loadStructure(path = '') {
            try {
                const response = await fetch('/list-financial-structure');
                const structure = await response.json();

                if (structure.error) {
                    document.getElementById('structure-list').innerHTML = `<p class="error">${structure.error}</p>`;
                    return;
                }

                updatePathNavigation(path);

                const uploadSection = document.getElementById('folder-upload');
                if (path || structure.length > 0) {
                    uploadSection.classList.remove('hidden');
                } else {
                    uploadSection.classList.add('hidden');
                }

                const currentStructure = findStructureByPath(structure, path);
                renderStructureList(currentStructure);
            } catch (error) {
                console.error('åŠ è½½ç›®å½•ç»“æ„å¤±è´¥:', error);
            }
        }

        function updatePathNavigation(currentPath) {
            const pathContainer = document.getElementById('structure-path');
            pathContainer.innerHTML = '';

            const rootItem = document.createElement('span');
            rootItem.className = 'path-item';
            rootItem.setAttribute('data-path', '');
            rootItem.textContent = 'æ ¹ç›®å½•';
            rootItem.addEventListener('click', () => loadStructure(''));
            pathContainer.appendChild(rootItem);

            if (!currentPath) return;

            const pathParts = currentPath.split('/');
            let fullPath = '';

            pathParts.forEach((part, index) => {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                pathContainer.appendChild(separator);

                fullPath = index === 0 ? part : `${fullPath}/${part}`;

                const pathItem = document.createElement('span');
                pathItem.className = 'path-item';
                pathItem.setAttribute('data-path', fullPath);
                pathItem.setAttribute('data-name', part);
                pathItem.textContent = part;

                (function(currentFullPath) {
                    pathItem.addEventListener('click', () => {
                        loadStructure(currentFullPath);
                    });
                })(fullPath);

                pathContainer.appendChild(pathItem);
            });
        }

        function findStructureByPath(structure, path) {
            if (!path) return structure;

            const pathParts = path.split('/');
            let currentStructure = structure;

            for (const part of pathParts) {
                const found = currentStructure.find(item => item.name === part && item.is_dir);
                if (!found) return [];
                currentStructure = found.children;
            }

            return currentStructure;
        }

        function renderStructureList(structure) {
            const listContainer = document.getElementById('structure-list');
            listContainer.innerHTML = '';

            if (structure.length === 0) {
                listContainer.innerHTML = '<p>è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</p>';
                return;
            }

            const folders = structure.filter(item => item.is_dir);
            const files = structure.filter(item => !item.is_dir);

            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'file-item';

                const currentPath = getCurrentPath();
                const folderPath = currentPath ? `${currentPath}/${folder.name}` : folder.name;

                folderItem.innerHTML = `
                    <span class="folder-item" data-path="${folderPath}">ğŸ“ ${folder.name}</span>
                    <div class="file-actions">
                        <button class="build-btn" data-path="${folderPath}">Build</button>
                    </div>
                `;
                listContainer.appendChild(folderItem);
            });

            <!-- ä¿®æ”¹å -->
            files.forEach(file => {
                const allowedExtensions = ['.txt', '.md', '.rst', '.csv', '.xlsx', '.xls', '.docx', '.doc','.pdf'];
                const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));

                if (ext && allowedExtensions.includes(ext)) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';

                    const currentPath = getCurrentPath();
                    const filePath = currentPath;

                    fileItem.innerHTML = `
                        <span class="file-name">ğŸ“„ ${file.name}</span>
                        <div class="file-actions">
                            <button class="delete-btn" data-file="${file.name}" data-path="${filePath}">åˆ é™¤</button>
                        </div>
                    `;
                    listContainer.appendChild(fileItem);
                }
            });

            document.querySelectorAll('.folder-item').forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.getAttribute('data-path');
                    loadStructure(path);
                });
            });

            document.querySelectorAll('.build-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const folderPath = e.target.getAttribute('data-path');

                    if (confirm(`ç¡®å®šè¦ç¼–è¯‘æ–‡ä»¶å¤¹ "${folderPath}" å—ï¼Ÿ`)) {
                        try {
                            const response = await fetch('/build-folder', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ folder_path: folderPath })
                            });

                            const result = await response.json();
                            if (result.error) {
                                alert(result.error);
                            } else {
                                alert(result.message);
                            }
                        } catch (error) {
                            alert('ç¼–è¯‘å¤±è´¥: ' + error.message);
                        }
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const filename = e.target.getAttribute('data-file');
                    const filepath = e.target.getAttribute('data-path');

                    const fullPath = filepath ? `${filepath}/${filename}` : filename;

                    if (confirm(`ç¡®å®šè¦åˆ é™¤ ${fullPath} å—?`)) {
                        await deleteFile(fullPath);
                    }
                });
            });
        }

        async function deleteFile(filename) {
            try {
                const response = await fetch('/delete-financial-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: filename })
                });

                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('æ–‡ä»¶å·²åˆ é™¤');
                    loadStructure(getCurrentPath());
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        // æ–°å¢ï¼šæ˜¾ç¤ºçŸ¥è¯†åº“æµè§ˆå™¨
        function showKnowledgeBaseBrowser() {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'kb-browser-modal';
            modal.innerHTML = `
                <div class="kb-browser-content">
                    <h3>é€‰æ‹©çŸ¥è¯†åº“è·¯å¾„</h3>
                    <div id="kb-browser-path">
                        <span class="path-item" data-path="">æ ¹ç›®å½•</span>
                    </div>
                    <div id="kb-browser-list"></div>
                    <div class="modal-buttons">
                        <button id="select-kb-path">é€‰æ‹©æ­¤è·¯å¾„</button>
                        <button id="close-kb-browser">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const basePath = '/data/knowledge_base/';
            // åŠ è½½æ ¹ç›®å½•ç»“æ„
            loadKbBrowserStructure('', modal);

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('close-kb-browser').addEventListener('click', () => {
                modal.remove();
            });

            document.getElementById('select-kb-path').addEventListener('click', () => {
                const currentPath = getKbBrowserCurrentPath(modal);
                const fullPath = basePath + (currentPath ? currentPath : '');
                document.getElementById('knowledge-base-path').value = fullPath;
                modal.remove();
            });
        }

        // åŠ è½½çŸ¥è¯†åº“æµè§ˆå™¨çš„ç›®å½•ç»“æ„
        async function loadKbBrowserStructure(path = '', modal) {
            try {
                const response = await fetch('/list-financial-structure');
                const structure = await response.json();

                if (structure.error) {
                    modal.querySelector('#kb-browser-list').innerHTML = `<p class="error">${structure.error}</p>`;
                    return;
                }

                updateKbBrowserPathNavigation(path, modal);

                const currentStructure = findStructureByPath(structure, path);
                renderKbBrowserStructureList(currentStructure, path, modal);
            } catch (error) {
                console.error('åŠ è½½ç›®å½•ç»“æ„å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çŸ¥è¯†åº“æµè§ˆå™¨çš„è·¯å¾„å¯¼èˆª
        function updateKbBrowserPathNavigation(currentPath, modal) {
            const pathContainer = modal.querySelector('#kb-browser-path');
            pathContainer.innerHTML = '';

            const rootItem = document.createElement('span');
            rootItem.className = 'path-item';
            rootItem.setAttribute('data-path', '');
            rootItem.textContent = 'æ ¹ç›®å½•';
            rootItem.addEventListener('click', () => loadKbBrowserStructure('', modal));
            pathContainer.appendChild(rootItem);

            if (!currentPath) return;

            const pathParts = currentPath.split('/');
            let fullPath = '';

            pathParts.forEach((part, index) => {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                pathContainer.appendChild(separator);

                fullPath = index === 0 ? part : `${fullPath}/${part}`;

                const pathItem = document.createElement('span');
                pathItem.className = 'path-item';
                pathItem.setAttribute('data-path', fullPath);
                pathItem.textContent = part;
                pathItem.addEventListener('click', () => loadKbBrowserStructure(fullPath, modal));

                pathContainer.appendChild(pathItem);
            });
        }

        // æ¸²æŸ“çŸ¥è¯†åº“æµè§ˆå™¨çš„ç›®å½•åˆ—è¡¨
        function renderKbBrowserStructureList(structure, currentPath, modal) {
            const listContainer = modal.querySelector('#kb-browser-list');
            listContainer.innerHTML = '';

            if (structure.length === 0) {
                listContainer.innerHTML = '<p>è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶å¤¹</p>';
                return;
            }

            // åªæ˜¾ç¤ºæ–‡ä»¶å¤¹
            const folders = structure.filter(item => item.is_dir);

            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'kb-browser-folder';

                const folderPath = currentPath ? `${currentPath}/${folder.name}` : folder.name;

                folderItem.innerHTML = `ğŸ“ ${folder.name}`;
                folderItem.setAttribute('data-path', folderPath);
                folderItem.addEventListener('click', () => {
                    loadKbBrowserStructure(folderPath, modal);
                });

                listContainer.appendChild(folderItem);
            });
        }

        // è·å–çŸ¥è¯†åº“æµè§ˆå™¨å½“å‰è·¯å¾„
        function getKbBrowserCurrentPath(modal) {
            const pathItems = modal.querySelectorAll('#kb-browser-path .path-item');
            if (pathItems.length === 0) return '';

            const lastItem = pathItems[pathItems.length - 1];
            return lastItem.getAttribute('data-path') || '';
        }
    </script>
</body>
</html>